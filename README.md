üìÑ Relat√≥rio T√©cnico: Suportvip SMS Connector (Android ‚Üî Gmail)Vers√£o: 1.0 (Google Workspace Edition)Objetivo: Capturar SMS em dispositivos Android e encaminh√°-los via e-mail utilizando a infraestrutura do Google (Apps Script + Sheets + Gmail), contornando limita√ß√µes de SMTP externo e garantindo alta entregabilidade.1. Vis√£o Geral da ArquiteturaO sistema opera em um fluxo unidirecional (Do Aparelho para o E-mail), composto por 4 camadas:Cliente (Android App): Ouve os SMS, filtra localmente (opcional), empacota os dados e faz o envio seguro.API Gateway (Apps Script): Recebe a requisi√ß√£o POST, valida a seguran√ßa e processa a l√≥gica de neg√≥cio.Banco de Dados (Google Sheets): Armazena a lista de usu√°rios, tokens de licen√ßa, status de pagamento e v√≠nculo de hardware (Device ID).Transporte (Gmail Nativo): Realiza o disparo do e-mail e a limpeza autom√°tica (autoexclus√£o) para privacidade.2. Fluxo de Dados Detalhado (Step-by-Step)Para corrigir bugs, siga este rastro. Se o processo parar, verifique a etapa correspondente.Etapa A: No Dispositivo Android (Origem)Gatilho: O Android recebe um SMS (android.provider.Telephony.SMS_RECEIVED).Captura: O BroadcastReceiver acorda, extrai o Corpo da Mensagem e o N√∫mero do Remetente.Autentica√ß√£o Local: O App busca o user_token salvo nas prefer√™ncias (SharedPreferences). Se n√£o houver token (usu√°rio deslogado), o processo morre aqui.Identidade: O App captura o device_id (Android ID) para garantir que a licen√ßa n√£o est√° sendo clonada.Transmiss√£o: O App monta um JSON e envia via POST para a URL do Web App (/exec).Ponto de Falha Comum: App sem internet ou bloqueio de economia de bateria do Android matando o processo de fundo.Etapa B: No Google Apps Script (Processamento)Handshake: O Script recebe o JSON. Se o JSON estiver quebrado ou chaves faltando, retorna erro imediato.Filtro de Conte√∫do (Regex): Antes de qualquer coisa, verifica se o texto cont√©m palavras proibidas ("bet365", "tigrinho", etc.). Se contiver, retorna success_filtered e n√£o envia e-mail.Verifica√ß√£o de Infra: Checa a cota di√°ria do Gmail (MailApp.getRemainingDailyQuota()). Se < 10, aborta para proteger a conta.Etapa C: Valida√ß√£o no Google Sheets (Regra de Neg√≥cio)Lookup: O script abre a aba Usuarios_Sms e varre a coluna de Tokens.Valida√ß√µes em Cascata:Token existe? (N√£o -> Erro)Status √© "ATIVO"? (N√£o -> Erro)Data de Vencimento > Hoje? (N√£o -> Erro)Device ID bate com o registrado?Cen√°rio 1 (Novo): Campo vazio na planilha -> Grava o ID recebido (Vincula√ß√£o).Cen√°rio 2 (Diferente): ID da planilha != ID recebido -> Bloqueia (Tentativa de fraude/uso em m√∫ltiplos aparelhos).Etapa D: A√ß√£o Final (Envio e Limpeza)Disparo: Se tudo for aprovado, monta o HTML e usa GmailApp.sendEmail para o e-mail cadastrado na planilha (Coluna C).Privacidade (Autoexclus√£o): O script aguarda 3 segundos, busca o e-mail na pasta "Enviados" pelo ID √∫nico no assunto e o move para a Lixeira.Resposta: Retorna JSON { "status": "success" } para o Android fechar a conex√£o.3. Especifica√ß√µes T√©cnicas dos Dados3.1 Payload JSON (Android -> Script)Ocorrer√° erro se os nomes das chaves n√£o forem exatamente estes:JSON{
  "license_key": "STRING (Token do usu√°rio)",
  "device_id": "STRING (ID √∫nico do hardware)",
  "sms_content": "STRING (Texto da mensagem)",
  "sender_number": "STRING (Telefone de quem enviou)"
}
3.2 Mapeamento da Planilha (Database)Baseado no c√≥digo atual. Se alterar a ordem das colunas na planilha, o c√≥digo quebrar√°.√çndice (Array JS)Coluna ExcelCampoFun√ß√£o no Scriptrow[0]CE-mailDestinat√°rio do alerta.row[1]DDevice IDSeguran√ßa (Lock de Hardware). O script GRAVA aqui se estiver vazio.row[2]ETokenChave prim√°ria de busca.row[3]FVencimentoData para valida√ß√£o de acesso.row[4]GStatusDeve ser "ATIVO" (Case sensitive).4. C√≥digos de Erro e Diagn√≥sticoUse esta tabela para entender o que o App Android pode reportar nos Logs:Status JSONMensagem Prov√°velCausa RaizSolu√ß√£oerror"Credenciais incompletas"App enviou JSON faltando campos.Verificar c√≥digo Kotlin (SmsSenderService).error"Token inv√°lido"Token n√£o existe na planilha.Verificar digita√ß√£o na planilha ou no App.error"Licen√ßa inativa"Coluna G n√£o est√° "ATIVO".Ajustar status na planilha.error"Licen√ßa vencida"Data na Coluna F √© passado.Renovar data na planilha.error"Token vinculado a outro aparelho"O usu√°rio trocou de celular.Apagar o conte√∫do da c√©lula da Coluna D para permitir novo v√≠nculo.success_filtered"Mensagem filtrada..."Regex pegou palavra proibida.Funcionamento normal. Se for falso positivo, ajustar Regex.error"Limite di√°rio... atingido"Cota do Gmail estourou (1500).Aguardar 24h ou usar outra conta Workspace.5. Procedimentos de Manuten√ß√£oComo resetar um usu√°rio que trocou de celular?V√° na planilha Usuarios_Sms.Encontre a linha do usu√°rio.Apague o conte√∫do da Coluna D (Device ID).No pr√≥ximo envio, o sistema vincular√° o novo aparelho automaticamente.Como adicionar novas palavras ao filtro de spam?Abra o Apps Script.Edite a vari√°vel var REGEX_FILTRO_SMS.Adicione a palavra separada por | (pipe). Ex: ...|bet365|novo-spam|....Salve e clique em Implantar > Gerenciar Implanta√ß√µes > Editar > Nova Vers√£o (Isso √© crucial, sen√£o a mudan√ßa n√£o entra no ar).O e-mail n√£o chega, mas o App diz "Sucesso".Verifique a Lixeira do Gmail da conta suportvip. O script move o e-mail para l√° imediatamente.Verifique a pasta de Spam do destinat√°rio final.6. Considera√ß√µes de Seguran√ßa e PrivacidadeDados Sens√≠veis: O sistema foi desenhado para n√£o armazenar o conte√∫do do SMS na planilha (apenas metadados de envio s√£o processados). O conte√∫do reside apenas temporariamente no corpo do e-mail na Lixeira.API Exposta: A URL do Web App √© p√∫blica. A seguran√ßa depende inteiramente do license_key. Recomenda-se tokens longos e aleat√≥rios.Bateria do Android: O Android tende a matar servi√ßos em segundo plano.Recomenda√ß√£o: Instruir o usu√°rio a desativar "Otimiza√ß√£o de Bateria" para o App Suportvip nas configura√ß√µes do Android.
